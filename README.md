# SoC_WINRV32ICMF
Dự án SoC tập trung vào tối ưu hiệu suất mục tiêu để chạy mô hình phân loại AI với CPUpipeline sử dụng kiến trúc tập lệnh RISC-V 32 bit bao gồm tập lệnh cơ sở I, tập lệnh mở rộng M, tập lệnh mở rộng C và tập lệnh mở rộng F. Tích hợp bộ đồng xử lý FPUpipeline, hỗ trợ 62 ngắt, các ngoại vi I2C, SPI, UART, TIMER, GPIO, PLIC, dự đoán rẽ nhánh, quản lý phụ thuộc dữ liệu, etc.
- Tập lệnh cơ sở I: Bao gồm các lệnh toán học, logic, chuyển điều khiển cơ bản bắt buộc phải có của mỗi bộ xử lý RISC-V
- Tập lệnh mở rộng M: Bổ xung thêm các lệnh nhân, chia, chia dư. Trong dự án này ALU sử dụng thuật toán radix-4 cho cả phép nhân và phép chia. Nhân sẽ mất 9 chu kì và chia mất 20 chu kì.
- Tập lệnh mở rộng C: Bổ xung thêm các lệnh 16 bit làm giảm độ dài mã chương trình tức giảm bộ nhớ lệnh cần sử dụng.
- Tập lệnh mở rộng F: Bổ xung thêm các lệnh thao tác với số thực độ chính xác đơn. Tập này được bộ đồng xử lý FPU thực thi theo chuẩn IEEE754.
## 1. CPU 
- Được thiết kế tối ưu hiệu suất với thông lượng của tất cả các lệnh đều là 1 lệnh mỗi chu kì ngoại trừ lệnh JALR với thông lượng 0.25 lệnh mỗi chu kì. CPU áp dụng kĩ thuật đường ống 5 chu kì cơ bản IF-ID-EX-MEM-WB.
- Hỗ trợ dự đoán rẽ nhánh với bộ dự đoán rẽ nhánh 2 bit kết hợp với bảng lịch sử rẽ nhánh. Bộ dự đoán rẽ nhánh hoạt động hiệu quả đối với chương trình C/C++ mang tính lặp lại như hàm while, for, etc tuy nhiên hoạt động kém hiệu quả đối với loại chương trình mang tính lúc nhảy lúc không như zich zac. Đối với mô hình AI trong dự án tỷ lệ dữ đoán rẽ nhánh đúng rơi vào khoảng từ 98% tới 99% do chương trình AI có tính lặp lại nhiều lần cho mỗi pixel ảnh. Dự đoán rẽ nhánh sai sẽ phải trả giá bằng 2 chu kì tần số.
- Hỗ trợ bộ quản lý ngắt giúp chương trình điều khiển được ngắt của hệ thống bao gồm ngắt ngoài, ngoại lệ của từng chế độ. Tuy nhiên bộ xử lý chỉ hỗ trợ chế độ máy tức là chế độ có quyền cao nhất.
- Hỗ trợ quản lý phụ thuộc dữ liệu với chức năng xử lý tất cả các loại phụ thuộc dữ liệu mà không phải trả giá ngoại trừ lệnh JALR sẽ được chèn thêm 3 lệnh nop. Xung đột tài nguyên xảy ra khi truy cập cả lệnh và dữ liệu sẽ được xử lý bằng kiến trúc máy tính Harvard.
- Khối số học và logic xử lý các lệnh nhân chi số nguyên bằng thuật toán Radix-4, riêng với nhân Radix-4 sẽ được thực thi song song làm tăng tài nguyên và diện tích sử dụng tuy nhiên sẽ đẩy nhanh quá trình tính toán.
- Hỗ trợ 4 được bus riêng bao gồm Ibus, Dbus sử dụng localbus; Bus ngoại vi sử dụng AHB và APB; Bus FPU-CPU sử dụng bus đăc biệt được thiết kế riêng phù hợp yêu cầu trao đổi giữa CPU và FPU.
## 2. FPU
- Đươc thiết kế với 3 chế độ hoạt động bao gồm ModePipeline, ModeFSM và ModeCom. ModeCom thực thi các lệnh cần trao đổi dữ liệu với CPU thực thi ngay lật tức theo kiểu logic tổ hợp, ModeFSM thự thi các lệnh như FDIV, FSQRT là các lệnh cần thời gian tính toán lên tới 20 chu kì mỗi lệnh vì vậy không hợp ghép vào đường ống mà sẽ được thực thi bằng máy trạng thái. ModePipeline thực thi hầu hết các lệnh tính toán của FPU áp dụng kĩ thuật đường ống 7 chu kì Unpack-Align-Ope1-Ope2-Nor1-Nor2-R&WB.
Thuật toán nhân sử dụng là Radix4 song song theo kiểu số thực, thuật toán chia sử dụng là Newton-Raphson, thuật toán căn bậc 2 sử dụng là dự đoán digit-by-digit theo kiểu số thực, etc. Tất cả các lệnh của FPU đề có độ chính xác và tuân theo tiêu chuẩn IEEE754.
## 3. Ngoại vi
- Hỗ trợ ngoại vi I2C, SPI, UART, TIMER, GPIO và PLIC.
- UART Hỗ trợ chức năng lựa chọn baud rate 600bps, 1200bps, 2400bps, 4800bps, 9600bps, 14400bps, 19200bps, 38400bps, 56000bps, 57600bps và 115200bps. Chỉ hỗ trợ báo cáo trạng thái bận và RXNE. Có 2 đường ngắt nối tới PLIC là ngắt báo đã truyền xong dữ liệu và ngắt báo nhận được dữ liệu.
- Ngoại vi I2C được trang bị đầy đủ chức năng, hỗ trợ người dùng dự động hóa hết tất cả các thao tác. Để sử dụng chỉ việc khởi tạo I2C tiếp tới đưa dữ liệu vào thanh ghi gữ liệu và bật truyền, mọi thứ còn lại sẽ được phần cứng lo. Các chức năng hỗ trợ như lựa chọn độ dài địa chỉ slave, lựa chọn có truyền địa chỉ thanh ghi không, lựa chọn truyền, nhận bao nhiêu byte, lựa chọn độ rộng xung SCL, lựa chọn vị trí lấy mẫu và tùy chọn có repeatstart hay không. Hỗ trợ báo cáo trạng thái ngoại vi như bận, có nhận diện được slave không, RXNE, cờ báo lỗi, cờ báo hoàn thành nhận và cờ báo hoàn thành truyền. Có thể lựa chọn tần số SCL như 10KHz, 20KHz, 50KHz, 100KHz, 150KHz, 200KHz, 250KHz, 400KHz.
- Ngoại vi GPIO cung cấp 16 chân tín hiệu mục đích chung có thể cấu hình vào ra tùy ý. Có thể đọc, ghi tùy ý. Ngoại vi GPIO có 32 đường tín hiệu ngắt nối tới PLIC bao gồm 16 tín hiệu ngắt báo phát hiện sườn lên của GPIO và 16 tín hiệu ngắt báo phát hiện sườn xuống của GPIO.
- Bộ định thời TIMER bản chất được cấu tạo từ 2 khối là khối đếm và khối chức năng nâng cao và cả 2 khối có thể hoạt động đồng thời. Tức là có thể vừa dùng timer để tạo trễ vừa dùng để xuất xung PWM hoặc dùng chức năng Capture đưa ra độ rộng xung đưa vào. Khối đếm hỗ trợ tùy chọn tự động nạp lại, lựa chọn đếm lên đếm xuống, lựa chọn tải giá trị vào thanh ghi đếm, lựa chọn bộ chia tần, lựa chọn chu kì đếm. Khối đếm này có 1 đường ngắt nối tới PLIC báo tràn. Khối chức năng nâng cao cung cấp 4 channel timer hỗ trợ chức năng PWM hoặc Capture có thể cấu hình. Có chức năng lựa chọn channel, chức năng lựa chọn kích hoạt số lượng channel, chức năng thay đổi chân đầu ra đảo lại cho từng channel, chức năng lựa chọn cực tính của tín hiệu, lựa chọn bộ chia tần, lựa chọn chu kì đếm và lựa chọn giá trị so sánh.
- Ngoại vi quản lý ngắt ngoài PLIC, hỗ trợ 62 ngắt các loại đến từ ngoại vi. Có khả năng cấu hình mức ưu tiên ngắt cho từng ngắt, cấu hình cho phép ngắt cho từng ngắt, cấu hình ngưỡng ngắt. Hỗ trợ đọc trạng thái của bộ quản lý ngắt như ngắt nào đang chờ, ngắt nào đang được thực hiện. Thời gian tìm ra ngắt cao nhất và báo cáo cho CPU là 32 chu kì.
- Ngoại vi SPI hỗ trợ lựa chọn tần số SCLK là 100KHz, 200KHz, 500KHz, 800KHz, 1MHz, 2MHz, 4MHz, 5MHz. Có thể lựa chọn frame truyền lên tới 64bit, lựa chọn CPOL, CPHA, truyền MSB hay không. Có chức năng tự động chọn slave với ID của slave lưu trong thanh ghi cấu hình. Hỗ trợ cả chế độ master lẫn slave. Có 2 đường ngắt báo nhận được dữ liệu và đã truyền xong dữ liệu. Có thanh ghi trạng thái báo bận, RXNE...
## 4. Mô hình hệ thống SoC


